package se.devscout.scoutapi;

import io.dropwizard.testing.junit.DropwizardAppRule;
import org.junit.ClassRule;
import org.junit.Test;
import se.devscout.scoutapi.model.Activity;
import se.devscout.scoutapi.model.ActivityProperties;
import se.devscout.scoutapi.model.ActivityRatingAttrs;
import se.devscout.scoutapi.resource.v1.FavouritesResourceV1;

import javax.ws.rs.client.Entity;
import javax.ws.rs.core.Response;
import java.io.IOException;
import java.net.HttpURLConnection;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Stream;

import static io.dropwizard.testing.FixtureHelpers.fixture;
import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.Assert.assertTrue;

public class ActivitiesIntegrationTest extends IntegrationTest {

    @ClassRule
    public static final DropwizardAppRule<ScoutAPIConfiguration> RULE = createRule();

    @Test
    public void testActivityCRUD() throws IOException {
        assertThat(getActivities()).hasSize(0);

        Activity createdActivity = createActivity("fixtures/activity_properties_1.json");
        long activityId = createdActivity.getId();
        assertThat(activityId).isGreaterThan(0);
        assertThat(createdActivity.getProperties().getName()).isEqualTo("A New Activity");
        assertThat(createdActivity.getProperties().getDescriptionMaterial()).isEqualTo("Materials");
        assertThat(createdActivity.getProperties().getAgeMin()).isEqualTo(5);
        assertThat(createdActivity.getProperties().getTags()).hasSize(2);
        assertThat(createdActivity.getProperties().getMediaFiles()).hasSize(2);

        assertThat(getActivities()).hasSize(1);

        Activity readActivity = getActivity(activityId);
        assertThat(readActivity.getProperties().getName()).isEqualTo("A New Activity");

        updateActivity(activityId, "fixtures/activity_properties_2.json", true);

        Activity patchedActivity = getActivity(activityId);
        assertThat(patchedActivity.getProperties().getName()).isEqualTo("A Patched Activity");
        assertThat(patchedActivity.getProperties().getDescriptionMaterial()).isEqualTo("Materials");
        assertThat(createdActivity.getProperties().getAgeMin()).isEqualTo(5);
        assertThat(patchedActivity.getProperties().getTags()).hasSize(2);
        assertThat(patchedActivity.getProperties().getMediaFiles()).hasSize(2);

        updateActivity(activityId, "fixtures/activity_properties_3.json", false);

        Activity updatedActivity = getActivity(activityId);
        assertThat(updatedActivity.getProperties().getName()).isEqualTo("An Updated Activity");
        assertThat(updatedActivity.getProperties().getDescriptionMaterial()).isEqualTo("Materials");
        assertThat(updatedActivity.getProperties().getDescriptionIntroduction()).isEqualTo("The Introduction Has Been Updated");
        assertThat(createdActivity.getProperties().getAgeMin()).isEqualTo(5);
        assertThat(updatedActivity.getProperties().getTags()).hasSize(1);
        assertThat(updatedActivity.getProperties().getMediaFiles()).hasSize(1);

        deleteActivity(activityId);

        assertThat(getActivities()).hasSize(0);
    }

    @Test
    public void testRatings() throws Exception {
        Activity createdActivity = createActivity("fixtures/activity_properties_1.json");
        long activityId = createdActivity.getId();

        // Get ratings for activity and verify that no ratings exist.
        checkActivityRatings(-1.0, 0, 0, activityId, 0);

        // Set rating for user 1
        setActivityRating(activityId, 5, false, HEADER_AUTHORIZATION_VALUE_USER);

        // Set rating and favourite for user 2
        setActivityRating(activityId, 4, true, HEADER_AUTHORIZATION_VALUE_MODERATOR);

        // Get activity and verify number of ratings and average rating.
        checkActivityRatings(4.5, 2, 9, activityId, 1);

        // Update rating for user 1
        setActivityRating(activityId, 3, false, HEADER_AUTHORIZATION_VALUE_USER);

        // Get activity and verify number of ratings and average rating.
        checkActivityRatings(3.5, 2, 7, activityId, 1);

        // Delete rating for user 2 (remove rating for activity but keep as favourite)
        unsetActivityRating(activityId, HEADER_AUTHORIZATION_VALUE_MODERATOR);

        // Get activity and verify number of ratings and average rating.
        checkActivityRatings(3.0, 1, 3, activityId, 1);
    }
}